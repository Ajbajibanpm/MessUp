<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Cantina del Killer</title>
    <!-- Carico Tailwind CSS per uno stile moderno e responsive -->
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Imposto il font Inter (consigliato per l'UI) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        /* Custom styles per l'input e l'area risultati */
        #resultBox {
            min-height: 120px;
            transition: all 0.3s ease;
        }
        #subjectFeedbackBox {
            min-height: 50px;
            transition: all 0.3s ease;
        }
        /* Stile per i soggetti cliccabili */
        .clickable-subject {
            cursor: pointer;
            transition: color 0.15s ease, font-weight 0.15s ease;
        }
        .clickable-subject:hover {
            color: #2563EB; /* Blu intenso */
            font-weight: 600;
        }
        /* Stili specifici per la nuova variabile "tipo" */
        .tipo-OGGETTO {
            font-weight: 700;
            color: #f59e0b; /* Giallo (Amber) per OGGETTO */
        }
        .tipo-RICORDO {
            font-weight: 700;
            color: #10b981; /* Verde (Emerald) per RICORDO */
        }
        /* Aggiungo un focus state personalizzato al pulsante */
        button:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(66, 153, 225, 0.5); /* blu */
        }
        .hidden { display: none; }

        /* Stili per il Modal di conferma */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            transform: translateY(-50px);
            transition: transform 0.3s ease;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body class="p-4 flex items-center justify-center">
    <div class="ski"><div class="chat-box"> </div>
    <div class="w-full max-w-md bg-white p-6 md:p-8 shadow-2xl rounded-xl">
        
        <div class="prova">
        
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">ESCAPE ROOM: <br> La cantina del Killer</h1>
        
        <!-- ============================================== -->
        <!-- FASE 1: INSERIMENTO CODICE GRUPPO -->
        <!-- ============================================== -->
        <div id="userIdView" class="space-y-6">
            <!-- Testo di istruzione AGGIORNATO (senza suggerimenti) -->
            <p class="text-center text-gray-500 mb-6">Inserisci il codice ricevuto per identificarti.</p>
            <div class="space-y-4">
                <input type="text" id="userIdInput" placeholder="Skibidiboppi"
                        class="w-full p-3 border-2 border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 text-lg uppercase tracking-wider"
                        maxlength="10" onkeyup="if(event.key === 'Enter') checkUserId()">
            
                <button onclick="checkUserId()"
                        class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 rounded-lg shadow-lg transition duration-200 ease-in-out transform hover:scale-[1.01]">
                    Verifica Identità
                </button>
            </div>
             </div>
            <!-- Messaggio di errore generico AGGIORNATO -->
            <p id="errorMsgUser" class="text-center text-red-500 hidden mt-2"></p>
        </div>

        <!-- ============================================== -->
        <!-- FASE 2: INSERIMENTO NOME PERSONALE -->
        <!-- ============================================== -->
        <div id="nameInputView" class="space-y-6 hidden">
            <p id="namePrompt" class="text-center text-gray-500 mb-6">Perfetto! Ora, inserisci il tuo nome per personalizzare l'esperienza.</p>
            <div class="space-y-4">
                <input type="text" id="nameInput" placeholder="Il tuo nome o nickname"
                        class="w-full p-3 border-2 border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500 text-lg tracking-wider"
                        maxlength="50" onkeyup="if(event.key === 'Enter') saveUserName()">
            
                <button onclick="saveUserName()"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg shadow-lg transition duration-200 ease-in-out transform hover:scale-[1.01]">
                    Conferma e Inizia
                </button>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- FASE 3: INSERIMENTO CODICI DI GIOCO -->
        <!-- ============================================== -->
        <div id="gameCodeView" class="space-y-6 hidden">
            <!-- Messaggio di benvenuto AGGIORNATO (mostra solo il nome) -->
            <p id="welcomeMessage" class="text-center text-green-600 font-semibold text-xl mb-4">Benvenuto!</p>
            <!-- Testo di istruzione AGGIORNATO (senza suggerimenti) -->
            <p class="text-center text-gray-500">Inserisci il codice di gioco che hai trovato.</p>

            <div class="space-y-4">
                <input type="text" id="codeInput" placeholder="Codice di Gioco"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg uppercase tracking-wider"
                        maxlength="50" onkeyup="if(event.key === 'Enter') checkCode()">
            
                <button onclick="checkCode()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-lg transition duration-200 ease-in-out transform hover:scale-[1.01]">
                    Controlla Codice
                </button>

                <!-- ****NUOVO PULSANTE DI RECAP -->
            <button onclick="showRecapConfirmation()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-lg transition duration-200 ease-in-out transform hover:scale-[1.01]">
                A cosa penso?
            </button> <!-- **** -->

            </div>
        
            <!-- Area di Feedback Soggetto (Nuovo/Duplicato) -->
            <div id="subjectFeedbackBox" class="mt-4 p-3 rounded-xl border-2 border-indigo-200 bg-indigo-50 flex items-center justify-center text-center hidden">
                <p id="subjectFeedbackMessage" class="text-indigo-700 font-semibold text-base italic">Soggetto: N/A</p>
            </div>

            <!-- Area dei Risultati/Messaggio (Contenuto del Codice) -->
            <div id="resultBox" class="mt-4 p-4 md:p-6 rounded-xl border border-dashed border-gray-300 flex items-center justify-center text-center">
                <p id="resultMessage" class="text-gray-500 italic text-base md:text-lg">Il risultato apparirà qui dopo aver inserito un codice.</p>
            </div>

            <!-- Lista dei Soggetti Trovati (Registro) -->
            <div id="submittedCodesList" class="mt-4 p-3 bg-gray-100 rounded-lg border border-gray-300">
                <p class="font-semibold text-gray-700 mb-1 text-sm">Registro Soggetti Sbloccati:</p>
                <!-- Gli elementi in questa lista sono cliccabili -->
                <div id="codeListContent" class="text-sm text-gray-600 italic">Nessun soggetto ancora sbloccato.</div>
            </div>

            <!-- NUOVO PULSANTE DI RESET -->
            <button onclick="showResetConfirmation()"
                    class="w-full mt-6 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg text-sm transition duration-200 ease-in-out">
                Ricomincia il Gioco (Reset Totale)
            </button>

        
        </div>

    </div>

    <!-- MODAL PER LA CONFERMA DEL RESET -->
    <div id="resetModal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h3 class="text-xl font-bold text-red-600 mb-3">Conferma Reset</h3>
            <p class="text-gray-700 mb-6">Sei sicuro di voler ricominciare? Uscirai dal gioco e il tuo personaggio verrà considerato non più in vita</p>
            <div class="flex justify-around space-x-4">
                <button onclick="hideResetConfirmation()"
                        class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
                    Annulla
                </button>
                <button onclick="resetUser()"
                        class="flex-1 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150">
                    Conferma Reset
                </button>
            </div>
        </div>
    </div>

    <!-- ***MODAL PER LA CONFERMA DEL RESET -->
    <div id="recapModal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h3 class="text-xl font-bold text-red-600 mb-3">Conferma Recap</h3>
            <p class="text-gray-700 mb-6"> senti... questa parte di codice non è ancora stata scritta </p>
            <div class="flex justify-around space-x-4">
            <button onclick="hideRecapConfirmation()"
                        class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
                    Torna indietro
                </button>
            </div> 
        </div>
    </div> <!-- *** --><div class="chat-sotto"></div>
</div>
</div>
    <script>
        // ------------------------------------------------------------------------------------------------
        // VARIABILI GLOBALI E COSTANTI
        // ------------------------------------------------------------------------------------------------

        // VARIABILE JOLLY: Inizializzata a ""
        let jolly = "";
        
        let currentUserPrefix = null;
        let currentUserName = null;
        const USER_PREFIX_KEY = 'gameUserPrefix';
        const USER_NAME_KEY = 'gameUserName';
        const SUBMITTED_CODES_KEY = 'submittedCodes';
        
        // I prefissi validi che l'utente può inserire (Nascosti dall'interfaccia)
        const VALID_PREFIXES = ["DETECTIVE", "MEDIUM", "BAMBINO"];

        // TABELLA DEI CODICI - Aggiornata con la variabile 'type'
        const CODE_MAP = {
            // Struttura: { subject: "NOME", message: "MESSAGGIO", type: "TIPO" }

            // OGGETTI (Codici X-001 a X-003)
            "DETECTIVE-001": { subject: "OROLOGIO", message: "Il tempo.. di attività è critico. La sequenza ha inizio: ora.", type: "OGGETTO"},
            "DETECTIVE-002": { subject: "ENERGIA", message: "Potenza insufficiente. Ristabilire il flusso agli ingranaggi secondari.", type: "OGGETTO" },
            "DETECTIVE-003": { subject: "MAPPA", message: "Coordinate acquisite. La destinazione è a est, oltre il punto X.", type: "OGGETTO" },
            // RICORDI (Codici rimanenti)
            "DETECTIVE-004": { subject: "CHIMICA", message: "Reazione completata con successo. Il composto è stabile e pronto all'uso.", type: "RICORDO" },
            "DETECTIVE-005": { subject: "ARCHIVIO", message: "Documento 'Project Phoenix' scaricato. Analisi dei dati in corso.", type: "RICORDO" },
            "DETECTIVE-006": { subject: "COMETA", message: "Anomalia rilevata. Un corpo celeste si avvicina alla nostra orbita.", type: "RICORDO" },
            "DETECTIVE-007": { subject: "CRIPTA", message: "Decrittazione completata. Il codice di accesso è stato svelato.", type: "RICORDO" },
            "DETECTIVE-008": { subject: "FOTO", message: "Immagine acquisita. Il soggetto è identificato con alta probabilità.", type: "RICORDO" },
            "DETECTIVE-009": { subject: "FLUIDO", message: "Il sistema idraulico è pressurizzato. Aprire la valvola lentamente.", type: "RICORDO" },
            "DETECTIVE-010": { subject: "PORTALE", message: "Attivazione completata. La transizione dimensionale è imminente.", type: "RICORDO" },

            // OGGETTI (Codici X-001 a X-003)
            "MEDIUM-001": { subject: "CLESSIDRA", message: "Ogni granello di sabbia è un sussurro del passato. Ascolta il ticchettio nascosto.", type: "OGGETTO" },
            "MEDIUM-002": { subject: "SCINTILLA", message: "L'elettricità è la forza vitale, la chiave per risvegliare l'antica macchina.", type: "OGGETTO" },
            "MEDIUM-003": { subject: "LABIRINTO", message: "Ogni svolta ti allontana dalla verità. Devi fidarti del tuo istinto, non della vista.", type: "OGGETTO" },
            // RICORDI (Codici rimanenti)
            "MEDIUM-004": { subject: "ALCHIMIA", message: "La fusione degli elementi rivela la formula segreta per la trasformazione.", type: "RICORDO" },
            "MEDIUM-005": { subject: "PERGAMENA", message: "I segreti sono celati nelle fibre antiche. La verità è scritta in un linguaggio dimenticato.", type: "RICORDO" },
            "MEDIUM-006": { subject: "COSTELAZIONE", message: "Guarda in alto. Le stelle formano un disegno, una guida tracciata dal destino.", type: "RICORDO" },
            "MEDIUM-007": { subject: "ENIGMA", message: "Ciò che è chiuso può essere aperto solo dalla logica e dalla paura. Risolvi l'indovinello.", type: "RICORDO" },
            "MEDIUM-008": { subject: "RIFLESSO", message: "L'immagine che vedi non è te. Guarda oltre il vetro per la vera forma.", type: "RICORDO" },
            "MEDIUM-009": { subject: "LACRIMA", message: "Solo le acque purificate possono scorrere. Il pianto della sorgente è la tua cura.", type: "RICORDO" },
            "MEDIUM-010": { subject: "SOGLIA", message: "Non è la fine, ma un nuovo inizio. Attraversa il velo dell'ignoto.", type: "RICORDO" },
            
            // OGGETTI (Codici X-001 a X-003)
            "BAMBINO-001": { subject: "TIMER", message: "Priorità 1: Punti di controllo. Mancano 60 secondi all'attivazione.", type: "OGGETTO" },
            "BAMBINO-002": { subject: "BATTERIA", message: "Alimenta la tua risorsa più vicina. L'indicatore è rosso.", type: "OGGETTO" },
            "BAMBINO-003": { subject: "PERCORSO", message: "Deviazione necessaria. Segui la linea rossa sul pavimento. Non fermarti.", type: "OGGETTO" },
            // RICORDI (Codici rimanenti)
            "BAMBINO-004": { subject: "MISCELA", message: "Combinare i liquidi A e C. Il risultato deve essere verde brillante.", type: "RICORDO" },
            "BAMBINO-005": { subject: "FASCICOLO", message: "Accesso al livello 3 ottenuto. Il file protetto è stato aperto.", type: "RICORDO" },
            "BAMBINO-006": { subject: "SATELLITE", message: "Connessione persa. Ricalibrare l'antenna parabolica verso il nord.", type: "RICORDO" },
            "BAMBINO-007": { subject: "BLOCCO", message: "Sistema di sicurezza attivato. Inserisci la sequenza numerica per disarmare il lucchetto.", type: "RICORDO" },
            "BAMBINO-008": { subject: "MONITOR", message: "Trasmissione video in arrivo. Concentrati sul dettaglio nell'angolo in alto a destra.", type: "RICORDO" },
            "BAMBINO-009": { subject: "TUBO", message: "C'è una perdita critica nel condotto principale. Ispeziona la giunzione.", type: "RICORDO" },
            "BAMBINO-010": { subject: "USCITA", message: "Hai raggiunto il punto di estrazione. Procedi con cautela. La missione è quasi terminata.", type: "RICORDO" },

            // ESEMPI PER CODICI NON DIPENDENTI DALL'UTENTE (generici)
            "FINALE": { subject: "COMPLETATO", message: "Complimenti a tutti! Avete completato l'Escape Game! Un'ottima performance. Il viaggio si conclude qui.", type: "RICORDO" },
        };

        // Riferimenti agli elementi HTML
        const userIdInput = document.getElementById('userIdInput');
        const nameInput = document.getElementById('nameInput');
        const codeInput = document.getElementById('codeInput');
        const resultMessage = document.getElementById('resultMessage');
        const resultBox = document.getElementById('resultBox');
        const userIdView = document.getElementById('userIdView');
        const nameInputView = document.getElementById('nameInputView');
        const gameCodeView = document.getElementById('gameCodeView');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const errorMsgUser = document.getElementById('errorMsgUser');
        const codeListContent = document.getElementById('codeListContent');
        const namePrompt = document.getElementById('namePrompt');
        const subjectFeedbackBox = document.getElementById('subjectFeedbackBox');
        const subjectFeedbackMessage = document.getElementById('subjectFeedbackMessage');
        const resetModal = document.getElementById('resetModal'); // Riferimento al Modal
        const recapModal = document.getElementById('recapModal'); // Riferimento al Modal

        // Funzione eseguita al caricamento della pagina
        window.onload = function() {
            loadUser();
        };

        // ----------------------------------------------------------------
        // GESTIONE DEL MODAL DI CONFERMA
        // ----------------------------------------------------------------
        window.showResetConfirmation = function() {
            resetModal.classList.remove('hidden');
        }

        window.hideResetConfirmation = function() {
            resetModal.classList.add('hidden');
        }

        // ----------------------------------------------------------------
        // ****GESTIONE DEL MODAL DI CONFERMA
        // ----------------------------------------------------------------
        window.showRecapConfirmation = function() {
            recapModal.classList.remove('hidden');
        }

        window.hideRecapConfirmation = function() {
            recapModal.classList.add('hidden');
        } // --*** -- //

        // ----------------------------------------------------------------
        // GESTIONE DEI CODICI SALVATI E DISPLAY DEI SOGGETTI
        // ----------------------------------------------------------------

        function getSubmittedCodes() {
            const codesJson = localStorage.getItem(SUBMITTED_CODES_KEY);
            return codesJson ? JSON.parse(codesJson) : [];
        }

        function setSubmittedCodes(codes) {
            localStorage.setItem(SUBMITTED_CODES_KEY, JSON.stringify(codes));
        }

        // Aggiunge un codice alla lista se non è già presente
        function addSubmittedCode(code) {
            let codes = getSubmittedCodes();
            if (!codes.includes(code)) {
                codes.push(code);
                setSubmittedCodes(codes);
                updateSubmittedCodesDisplay(codes); // Aggiorna la visualizzazione
                return true; // Codice NUOVO
            }
            return false; // Codice DUPLICATO
        }

        // AGGIORNATA: Aggiunge la visualizzazione del 'tipo' (OGGETTO/RICORDO)
        function updateSubmittedCodesDisplay(codes = null) {
            codes = codes || getSubmittedCodes();

            if (codes.length === 0) {
                codeListContent.textContent = "Nessun soggetto ancora sbloccato.";
            } else {
                let listHtml = '';
                codes.forEach(rawCode => {
                    const searchKey = `${currentUserPrefix}-${rawCode}`;
                    // Cerca il soggetto con chiave personalizzata o generica
                    let codeInfo = CODE_MAP[searchKey] || CODE_MAP[rawCode];
                    
                    const subject = codeInfo ? codeInfo.subject : `[Soggetto Sconosciuto]`;
                    const type = codeInfo ? codeInfo.type : `[TIPO SCONOSCIUTO]`; // Prende il tipo
                    
                    // Crea l'elemento con il prefisso di tipo
                    const prefixedSubject = `<span class="tipo-${type}">${type}</span>: ${subject}`;

                    // L'elemento <li> è reso cliccabile e chiama reSubmitCode con il codice grezzo (rawCode)
                    listHtml += `
                        <li class="clickable-subject"
                            onclick="reSubmitCode('${rawCode}')">
                            ${prefixedSubject}
                        </li>
                    `;
                });
            
                codeListContent.innerHTML = `<ul class="list-disc pl-5 mt-1">${listHtml}</ul>`;
            }
        }
        
        // Simula l'inserimento del codice cliccato dal registro
        window.reSubmitCode = function(rawCode) {
            // Imposta e immediatamente esegue la verifica
            codeInput.value = rawCode;
            checkCode();
        }

        // ----------------------------------------------------------------
        // GESTIONE AUTENTICAZIONE E SALVATAGGIO (FASE 1 & 2)
        // ----------------------------------------------------------------

        function loadUser() {
            const savedPrefix = localStorage.getItem(USER_PREFIX_KEY);
            const savedName = localStorage.getItem(USER_NAME_KEY);
            
            if (savedPrefix && savedName) {
                currentUserPrefix = savedPrefix;
                currentUserName = savedName;
                showGameView(savedName);
            } else if (savedPrefix) {
                currentUserPrefix = savedPrefix;
                showNameInputView();
            } else {
                showUserIdView();
            }
        }

        // Verifica l'ID del Gruppo (FASE 1)
        window.checkUserId = function() {
            let inputPrefix = userIdInput.value.trim().toUpperCase();

            if (inputPrefix.length < 1) {
                displayError(errorMsgUser, "Inserisci il codice del tuo gruppo.");
                return;
            }

            inputPrefix = inputPrefix.replace(/[^A-Z0-9]/g, '');

            if (VALID_PREFIXES.includes(inputPrefix)) {
                localStorage.setItem(USER_PREFIX_KEY, inputPrefix);
                currentUserPrefix = inputPrefix;
                displayError(errorMsgUser, "", true);
                // NOTA: I codici vengono resettati solo se si cambia gruppo, non ad ogni accesso.
                // Per un reset completo, l'utente deve usare il pulsante 'Reset Totale'.
                
                // Rimuovi l'eventuale nome salvato se si cambia gruppo
                localStorage.removeItem(USER_NAME_KEY);
                currentUserName = null; 

                updateSubmittedCodesDisplay([]);
                
                // Aggiorna il testo per la fase successiva
                namePrompt.textContent = `Perfetto! Ora, inserisci il tuo nome per personalizzare l'esperienza.`; 
                showNameInputView();
            } else {
                // Messaggio di errore generico AGGIORNATO
                displayError(errorMsgUser, `Codice gruppo non riconosciuto. Riprova con il codice fornito.`);
            }
        }
        
        // Salva il Nome (FASE 2)
        window.saveUserName = function() {
            const inputName = nameInput.value.trim();

            if (inputName.length < 2) {
                alertUser("Per favore, inserisci un nome valido.");
                return;
            }

            localStorage.setItem(USER_NAME_KEY, inputName);
            currentUserName = inputName;
            showGameView(inputName);
        }

        // Resetta l'utente (cancella tutto, inclusi i codici)
        window.resetUser = function() {
            // Nasconde il modal prima di resettare
            hideResetConfirmation(); 
             hideRecapConfirmation(); 

            localStorage.removeItem(USER_PREFIX_KEY);
            localStorage.removeItem(USER_NAME_KEY);
            localStorage.removeItem(SUBMITTED_CODES_KEY);
            jolly = ""; // Reset della variabile jolly
            currentUserPrefix = null;
            currentUserName = null;
            updateSubmittedCodesDisplay([]);
            displayResult("Il risultato apparirà qui dopo aver inserito un codice.", false, true); // Reset messaggio
            displaySubjectFeedback("", false, true); // Reset feedback soggetto
            showUserIdView();

            // Opzionale: notifica di reset (solo in console, dato che alert è vietato)
            console.log("Gioco resettato completamente.");
        }

        // ----------------------------------------------------------------
        // CAMBIO DI VISTA
        // ----------------------------------------------------------------

        function hideAllViews() {
            userIdView.classList.add('hidden');
            nameInputView.classList.add('hidden');
            gameCodeView.classList.add('hidden');
        }

        function showUserIdView() {
            hideAllViews();
            userIdView.classList.remove('hidden');
            userIdInput.value = "";
            userIdInput.focus();
        }

        function showNameInputView() {
            hideAllViews();
            nameInputView.classList.remove('hidden');
            nameInput.value = "";
            nameInput.focus();
        }

        function showGameView(name) {
            hideAllViews();
            // Mostra solo il nome nel messaggio di benvenuto
            welcomeMessage.textContent = `Benvenuto, ${name}!`;
            gameCodeView.classList.remove('hidden');
            codeInput.focus();
            updateSubmittedCodesDisplay();
        }


        // ----------------------------------------------------------------
        // GESTIONE RISULTATI E FEEDBACK
        // ----------------------------------------------------------------
        
        function displayError(element, message, hide = false) {
            if (hide || message === "") {
                element.classList.add('hidden');
            } else {
                element.textContent = message;
                element.classList.remove('hidden');
            }
        }

        // Funzione per mostrare il messaggio di risultato (successo o errore)
        function displayResult(message, isSuccess = true, isReset = false) {
            resultBox.classList.remove('border-gray-300', 'border-red-500', 'bg-red-100', 'border-green-500', 'bg-green-100', 'border-yellow-500', 'bg-yellow-100');
            resultMessage.classList.remove('text-gray-500', 'text-red-700', 'italic', 'text-green-800', 'font-semibold', 'text-yellow-800');
            
            if (isReset) {
                resultBox.classList.add('border-gray-300');
                resultMessage.textContent = message;
                resultMessage.classList.add('text-gray-500', 'italic');
            } else if (isSuccess) {
                // Successo (NUOVO CODICE o RIPETIZIONE)
                resultBox.classList.add('border-green-500', 'bg-green-100');
                resultMessage.textContent = message;
                resultMessage.classList.add('text-green-800', 'font-semibold');
            } else {
                // Errore (Codice NON valido)
                resultBox.classList.add('border-red-500', 'bg-red-100');
                resultMessage.textContent = message;
                resultMessage.classList.add('text-red-700');
            }
        }

        // Funzione per mostrare il feedback del soggetto (Nuovo/Duplicato/Errore)
        function displaySubjectFeedback(message, isNewSubject = true, isReset = false) {
            subjectFeedbackBox.classList.remove('hidden', 'border-red-400', 'bg-red-50', 'border-indigo-400', 'bg-indigo-100', 'border-gray-300', 'bg-gray-100');
            subjectFeedbackMessage.classList.remove('text-indigo-800', 'text-red-700', 'text-gray-700');
            
            if (isReset) {
                subjectFeedbackBox.classList.add('hidden');
                return;
            } else if (isNewSubject) {
                // Nuovo Soggetto (Feedback Positivo)
                subjectFeedbackBox.classList.add('border-indigo-400', 'bg-indigo-100');
                subjectFeedbackMessage.textContent = message;
                subjectFeedbackMessage.classList.add('text-indigo-800', 'font-semibold');
            } else {
                // Soggetto Già Noto (Feedback Neutro/Avviso)
                subjectFeedbackBox.classList.add('border-gray-300', 'bg-gray-100');
                subjectFeedbackMessage.textContent = message;
                subjectFeedbackMessage.classList.add('text-gray-700');
            }
            subjectFeedbackBox.classList.remove('hidden');
        }
        
        function alertUser(message) {
            console.error("ERRORE UTENTE:", message);
            displayResult(message, false);
            displaySubjectFeedback("Errore durante l'operazione.", false);
        }

        // Funzione principale di controllo del codice
        window.checkCode = function() {
            if (!currentUserPrefix || !currentUserName) {
                alertUser("ERRORE: I dati utente sono incompleti. Riavvia l'app e rifai l'accesso.");
                resetUser();
                return;
            }

            const inputGameCode = codeInput.value.trim().toUpperCase();
            // Pulisce l'input dopo l'uso, indipendentemente dalla fonte
            codeInput.value = '';

            if (inputGameCode === "") {
                displayResult("Per favore, inserisci un codice di gioco.", false);
                displaySubjectFeedback("", false, true);
                return;
            }

            // ==========================================================
            // LOGICA SPECIALE PER IL CODICE "001"
            // ==========================================================
            if (inputGameCode === "001") {
                jolly = "eh eh eh"; // Aggiorna la variabile jolly come richiesto
            }
            // ==========================================================
            
            let resultData = null; // Sarà l'oggetto { subject, message, type }
            let foundKey = null;
            const searchKey = `${currentUserPrefix}-${inputGameCode}`;

            // 1. Eseguo la ricerca con la chiave personalizzata o generica
            if (CODE_MAP.hasOwnProperty(searchKey)) {
                // Faccio una copia dell'oggetto per poter modificare il messaggio senza alterare la mappa originale
                resultData = {...CODE_MAP[searchKey]};
                foundKey = inputGameCode;
            } else if (CODE_MAP.hasOwnProperty(inputGameCode)) {
                // Faccio una copia
                resultData = {...CODE_MAP[inputGameCode]};
                foundKey = inputGameCode;
            } else {
                // Codice NON trovato
                displayResult(`"${inputGameCode}" non è un codice valido in questo momento. Riprova!`, false);
                displaySubjectFeedback("", false, true); // Nascondi il box feedback soggetto
                return;
            }

            // ==========================================================
            // AGGIUNTA DINAMICA DELLA VARIABILE JOLLY AL MESSAGGIO
            // ==========================================================
            // Applica la variabile 'jolly' al codice DETECTIVE-001 e DETECTIVE-002 come richiesto
            if (searchKey === "DETECTIVE-001" || searchKey === "DETECTIVE-002") {
                resultData.message += " " + jolly;
            }
            // ------------------------------------------------------------
            // LOGICA DI CONTROLLO DUPLICATO E FEEDBACK SOGGETTO
            // ------------------------------------------------------------
            
            const isNew = addSubmittedCode(foundKey); // Tenta di aggiungere il codice e verifica se è nuovo
            
            if (isNew) {
                // Codice NUOVO trovato
                displayResult(resultData.message, true);
                // Aggiorno il feedback con il TIPO
                displaySubjectFeedback(`Nuovo ${resultData.type}: ${resultData.subject}`, true);
            } else {
                // Codice DUPLICATO - RIPETI il messaggio e indica che è già noto
                displayResult(resultData.message, true); // Ripete il messaggio con lo stile di successo (verde)
                // Aggiorno il feedback con il TIPO
                displaySubjectFeedback(`${resultData.type}: ${resultData.subject} (già noto).`, false);
            }
        }
    </script>

</body>
</html>